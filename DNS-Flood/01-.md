# DNS Flooding 공격 실습 

### DNS Flooding 개념  

- DNS Flooding은 서버 자원이나 대역폭을 고갈시키는 방법 중 하나입니다.  
- DNS 프로토콜을 이용하여 대량의 질의 트래픽을 발생시켜서 서비스 가용성을 저하시키는 공격입니다.
- 일반적으로 UDP 기반으로 동작하며, UDP의 특성상 대량의 요청을 낮은 비용으로 전송이 가능합니다. 하지만 서버에서는 각 질의에 대해 비싼 처리가 필요한 경우, 서버측의 자원이 크게 소모될 수 있습니다.  
- DNS Query Flood와 DNS Reflection로 두가지 유형을 나누어서 소개하겠습니다. 

<br>

### DNS Flooding 공격 종류    
- DNS Query Flooding
    - 자원 소진 공격에 해당하며, 
    - DNS 서버에 대량의 DNS 질의를 보내서 정상 서비스를 할 수 없게 만드는 공격입니다. 
    - 공격자는 주로 다수의 봇넷을 활용하며, 짧은 시간동안 대량의 DNS 질의를 보내므로 자원이 소모되었다면 정상 사용자의 질의에 응답하지 못하게 됩니다. 

- DNS Reflection Attack
    - DRDoS 공격이며, 대역폭 공격에 해당합니다.
    - 출발지 ip를 공격 대상 피해자 ip 주소로 위조하여 dns 서버에 질의를 보냅니다. 
    - 해당 서버들이 생성한 대용량 응답은 피해자에게 전송이 되며 이로 인해 피해자의 대역폭을 고갈시키게 됩니다.
    - 응답 크기를 극대화하기 위해 DNS 서버의 모든 레코드를 요청하는 ANY 타입 질의를 사용하며, DNS 서버는 요청받은 패킷에 대해 증폭된 응답을 피해자에게 전달합니다.  

<br>

### DNS Query Flooding

- DNS Query Flooding 이란 DNS 서버가 처리해야하는 질의(쿼리)를 대량으로 발생시켜 서버의 자원을 고갈시키는 공격 기법입니다.
- 공격을 실행하기 위해서 다음과 같은 상황을 만들어냅니다.   
    - DNS 내부 큐 고갈
    - 업스트림 DNS의 응답 대기 시간 발생 
    - 캐시 미스 유발 

<br>

위와 같은 상황이 발생하면 DNS 서버의 자원은 자연스레 고갈됩니다.   
그럼 DNS 서버입장에서 어떤 일이 일어나는지도 확인해보겠습니다.  
- 쿼리 수신
- 캐시 확인
- 캐시에 없으면 업스트림 DNS에 질의
- 응답 대기
- 그동안 슬롯과 큐 점유
- 새 질의는 큐로 이동
- 큐 초과 시 drop

이 과정이 무수히 많이 겹치게된다면, 정상 사용자의 DNS 질의도 처리하지 못하게 됩니다.  
여기서 알 수 있는 점은 DNS Query Flooding은 느리게 처리되도록 만드는 것이 핵심임을 알 수 있습니다.  
<br>

그렇다면 이제 DNS Query Flooding의 대표적인 유형에 대해 알아보겠습니다.  
DNS Query Flooding은 질의의 성격에 따라 여러가지 유형으로 나뉩니다.  

- **Random Subdomain Attack (NXDOMAIN Flood)** : 가장 대표적인 방법으로 DNS Water torture 라고 불리기도 합니다. 존재하지 않는 무작위 서브도메인에 대한 쿼리를 대량으로 보냅니다. 그러면 공격 대상 서버는 존재하지 않는 도메인이라는 응답인 NXDOMAIN을 보내기 위해 계속해서 연산을 하게 됩니다. 
- **DNS Recursive Query Flood** : 공격자가 리졸버에게 많은 도메인에 대한 질의를 보냅니다. 이로인해 리졸버가 정상적인 사용자의 질의를 처리하지 못하는 상태로 만드는 것이 목표입니다. 
- **Direct Query Flood** : 타겟 DNS 서버의 ip 주소로 대량의 패킷을 보냅니다. 리졸버를 거치지 않고 공격을 하는 것이며, 주로 직접적으로 권한 DNS 서버를 공격할 때 사용합니다.  






<br>

### 일반적인 NXDOMAIN 오류 발생 구성

- **DNS 레코드 누락** : A, AAAA, CNAME과 같은 필수 레코드가 없는 경우 IP 주소를 확인할 수 없으므로 NXDOMAIN 응답이 발생합니다. 주로 DDNS와 같이 동적으로 서브도메인을 할당해주는 경우에 발생합니다.
- **잘못된 네임서버 위임** : 상위 도메인에 등록된 네임서버 정보가 실제 권한 서버와 일치하지 않은 경우 발생합니다.  
- **만료된 도메인** : 도메인 등록 기간이 만료되어 도메인이 제거되거나 비활성화된 상태에 발생합니다. 
- **DNSSEC 구성 오류** : DNS 응답이 위변조되지 않았음을 수학적으로 검증할 수 있는 DNSSEC이 활성화되어있을 때 서명정보가 올바르지 않은 경우 발생합니다. 
- **ZONE 파일 오류** : ZONE 파일에 오류가 있는 경우 발생합니다.  




<br>
<br>







### Reference  
- UDP Flooding 공격 : https://www.cloudflare.com/ko-kr/learning/ddos/udp-flood-ddos-attack/

- 자료:한국인터넷진흥원(KISA) DDOS 공격대응 가이드 : https://www.krcert.or.kr/kr/bbs/view.do?bbsId=B0000127&nttId=36186&menuNo=205021

- nxdomain : https://www.cloudns.net/blog/what-is-nxdomain/

